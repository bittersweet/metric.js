// Generated by CoffeeScript 1.4.0
(function() {
  var Metric;

  Metric = {
    setApiKey: function(api_key) {
      return this.api_key = api_key;
    },
    setUrl: function(url) {
      return this.url = url;
    },
    log: function(output) {
      if (console) {
        return console.log(output);
      }
    },
    track: function(metric, options) {
      var url;
      if (options == null) {
        options = {};
      }
      url = this.generateTrackingUrl(metric, options);
      return this.sendRequest(url, options.callback);
    },
    generateTimeString: function() {
      return (new Date).getTime().toString();
    },
    generateTrackingUrl: function(metric, options) {
      var amount, time, url;
      if (options == null) {
        options = {};
      }
      time = this.generateTimeString();
      url = this.url || "https://api.metric.io";
      amount = options.amount || 1;
      url = "" + url + "/v1/sites/" + this.api_key + "/track";
      return this.buildUrl(url, {
        metric: metric,
        amount: amount,
        time: time,
        meta: options.meta
      });
    },
    generateStatisticsUrl: function(metric, range, token) {
      var url;
      url = this.url || "https://api.metric.io";
      url = "" + url + "/v1/sites/" + this.api_key + "/statistics";
      return this.buildUrl(url, {
        metric: metric,
        metric: metric,
        range: range,
        token: token
      });
    },
    receive: function(metric, amount, token) {
      var url;
      url = this.generateStatisticsUrl(metric, amount, token);
      return this.sendRequest(url, callback);
    },
    sendRequest: function(url, callback) {
      var request;
      callback || (callback = this.log);
      request = new XMLHttpRequest();
      if (request.withCredentials !== void 0) {
        request.open("GET", url, true);
        request.onreadystatechange = function(e) {
          if (request.readyState === 4) {
            if (request.status === 200) {
              return callback(request.responseText);
            } else {
              return Metric.log("Bad HTTP status", request.status, request.statusText);
            }
          }
        };
        return request.send();
      }
    },
    buildUrl: function(url, parameters) {
      var key, querystring, value;
      querystring = "";
      for (key in parameters) {
        value = parameters[key];
        if (value) {
          querystring += encodeURIComponent(key) + "=" + encodeURIComponent(value) + "&";
        }
      }
      if (querystring.length > 0) {
        querystring = querystring.substring(0, querystring.length - 1);
        url = url + "?" + querystring;
      }
      return url;
    }
  };

  if (typeof window === 'undefined') {
    this.metric = Metric;
  } else {
    window.metric = Metric;
  }

}).call(this);
